# 腾讯云服务器部署指南

## 概述

本文档详细介绍了如何将 mksaas-template 项目部署到腾讯云服务器中。该项目是一个基于 Next.js 15 的 SaaS 模板，支持多种部署方式。

## 目录

- [服务器环境准备](#1-服务器环境准备)
- [项目配置](#2-项目配置)
- [部署方式选择](#3-部署方式选择)
- [数据库设置](#4-数据库设置)
- [反向代理配置](#5-反向代理配置)
- [SSL 证书配置](#6-ssl-证书配置)
- [监控和维护](#7-监控和维护)
- [备份策略](#8-备份策略)
- [性能优化](#9-性能优化)
- [故障排查](#10-故障排查)
- [安全建议](#11-安全建议)

## 1. 服务器环境准备

### 1.1 系统更新

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y
```

### 1.2 安装 Node.js 20

```bash
# 安装 Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

### 1.3 安装 PM2 进程管理器

```bash
# 安装 PM2
sudo npm install -g pm2

# 验证安装
pm2 --version
```

### 1.4 安装 Docker（可选）

```bash
# 安装 Docker
sudo apt install docker.io docker-compose -y

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
```

## 2. 项目配置

### 2.1 克隆项目

```bash
# 克隆项目到服务器
git clone https://github.com/your-repo/mksaas-template.git
cd mksaas-template
```

### 2.2 环境变量配置

```bash
# 复制环境变量模板
cp env.example .env.local
```

编辑 `.env.local` 文件，配置必要的环境变量：

```env
# -----------------------------------------------------------------------------
# Application BASE URL
# -----------------------------------------------------------------------------
NEXT_PUBLIC_BASE_URL="https://your-domain.com"

# -----------------------------------------------------------------------------
# Database
# -----------------------------------------------------------------------------
DATABASE_URL="postgresql://username:password@host:port/database"

# -----------------------------------------------------------------------------
# Better Auth
# -----------------------------------------------------------------------------
BETTER_AUTH_SECRET="your-secret-key"

# -----------------------------------------------------------------------------
# Github OAuth (可选)
# -----------------------------------------------------------------------------
GITHUB_CLIENT_ID=""
GITHUB_CLIENT_SECRET=""

# -----------------------------------------------------------------------------
# Google OAuth (可选)
# -----------------------------------------------------------------------------
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""

# -----------------------------------------------------------------------------
# Email / Newsletter (Resend)
# -----------------------------------------------------------------------------
RESEND_API_KEY=""
RESEND_AUDIENCE_ID=""

# -----------------------------------------------------------------------------
# Storage (腾讯云 COS)
# -----------------------------------------------------------------------------
STORAGE_REGION="ap-beijing"
STORAGE_BUCKET_NAME="your-bucket-name"
STORAGE_ACCESS_KEY_ID="your-access-key"
STORAGE_SECRET_ACCESS_KEY="your-secret-key"
STORAGE_ENDPOINT="https://cos.ap-beijing.myqcloud.com"
STORAGE_PUBLIC_URL="https://your-bucket.cos.ap-beijing.myqcloud.com"

# -----------------------------------------------------------------------------
# Payment (Stripe)
# -----------------------------------------------------------------------------
STRIPE_SECRET_KEY=""
STRIPE_WEBHOOK_SECRET=""
NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY=""
NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY=""
NEXT_PUBLIC_STRIPE_PRICE_LIFETIME=""

# -----------------------------------------------------------------------------
# Configurations
# -----------------------------------------------------------------------------
DISABLE_IMAGE_OPTIMIZATION=false
NEXT_PUBLIC_DEMO_WEBSITE=false
```

### 2.3 安装依赖

```bash
# 安装项目依赖
npm install
```

## 3. 部署方式选择

### 3.1 方式一：直接部署（推荐）

```bash
# 1. 构建项目
npm run build

# 2. 使用 PM2 启动应用
pm2 start npm --name "mksaas" -- start

# 3. 保存 PM2 配置
pm2 save

# 4. 设置开机自启
pm2 startup
```

### 3.2 方式二：Docker 部署

```bash
# 1. 构建 Docker 镜像
docker build -t mksaas-template .

# 2. 运行容器
docker run -d \
  --name mksaas-app \
  -p 3000:3000 \
  --env-file .env.local \
  mksaas-template

# 3. 查看容器状态
docker ps
docker logs mksaas-app
```

## 4. 数据库设置

### 4.1 腾讯云 PostgreSQL 配置

1. 在腾讯云控制台创建 PostgreSQL 实例
2. 获取连接信息并更新 `DATABASE_URL`
3. 运行数据库迁移：

```bash
# 生成迁移文件
npm run db:generate

# 执行迁移
npm run db:migrate
```

### 4.2 初始化数据（可选）

```bash
# 插入默认模型数据
npm run insert-default-models

# 创建商户用户
npm run create-merchant-user
```

### 4.3 数据库连接测试

```bash
# 测试数据库连接
npm run db:studio
```

## 5. 反向代理配置

### 5.1 安装 Nginx

```bash
# 安装 Nginx
sudo apt install nginx -y

# 启动 Nginx 服务
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 5.2 配置 Nginx

创建 Nginx 配置文件 `/etc/nginx/sites-available/mksaas`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 反向代理到 Next.js 应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 5.3 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/mksaas /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

## 6. SSL 证书配置

### 6.1 安装 Certbot

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y
```

### 6.2 获取 SSL 证书

```bash
# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 测试自动续期
sudo certbot renew --dry-run
```

### 6.3 设置自动续期

```bash
# 编辑 crontab
sudo crontab -e

# 添加以下行（每天凌晨 2 点检查续期）
0 2 * * * /usr/bin/certbot renew --quiet
```

## 7. 监控和维护

### 7.1 PM2 监控

```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs mksaas

# 重启应用
pm2 restart mksaas

# 停止应用
pm2 stop mksaas

# 删除应用
pm2 delete mksaas
```

### 7.2 系统监控

```bash
# 安装监控工具
sudo apt install htop iotop -y

# 查看系统资源
htop

# 查看磁盘使用情况
df -h

# 查看内存使用情况
free -h
```

### 7.3 日志监控

```bash
# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 查看应用日志
pm2 logs mksaas --lines 100
```

## 8. 备份策略

### 8.1 数据库备份

创建备份脚本 `/opt/backup/backup.sh`：

```bash
#!/bin/bash

# 设置变量
BACKUP_DIR="/opt/backup"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# 创建备份目录
mkdir -p $BACKUP_DIR

# 数据库备份
pg_dump $DATABASE_URL > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除旧备份文件
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete

# 记录备份日志
echo "$(date): Database backup completed - db_backup_$DATE.sql.gz" >> $BACKUP_DIR/backup.log
```

设置权限并添加到定时任务：

```bash
# 设置执行权限
chmod +x /opt/backup/backup.sh

# 添加到定时任务（每天凌晨 3 点执行）
crontab -e
# 添加：0 3 * * * /opt/backup/backup.sh
```

### 8.2 应用文件备份

```bash
# 备份应用文件
tar -czf /opt/backup/app_backup_$(date +%Y%m%d_%H%M%S).tar.gz /path/to/mksaas-template
```

## 9. 性能优化

### 9.1 Nginx 性能优化

在 `/etc/nginx/nginx.conf` 中添加：

```nginx
# 启用 Gzip 压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

# 连接优化
worker_connections 1024;
keepalive_timeout 65;
client_max_body_size 10M;
```

### 9.2 Node.js 性能优化

在 PM2 配置中设置：

```bash
# 使用集群模式启动
pm2 start npm --name "mksaas" -- start -i max

# 设置内存限制
pm2 start npm --name "mksaas" -- start --max-memory-restart 1G
```

### 9.3 系统优化

```bash
# 优化文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65536" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65536" >> /etc/sysctl.conf
sysctl -p
```

## 10. 故障排查

### 10.1 常见问题

#### 端口被占用
```bash
# 查看端口占用
sudo lsof -i :3000
sudo netstat -tlnp | grep :3000
```

#### 内存不足
```bash
# 查看内存使用
free -h
top

# 增加 swap 空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 数据库连接失败
```bash
# 测试数据库连接
psql $DATABASE_URL -c "SELECT 1;"

# 检查数据库状态
sudo systemctl status postgresql
```

#### 权限问题
```bash
# 修复文件权限
sudo chown -R $USER:$USER /path/to/mksaas-template
chmod +x /path/to/mksaas-template/scripts/*.sh
```

### 10.2 日志分析

```bash
# 查看错误日志
pm2 logs mksaas --err --lines 50

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# 查看系统日志
sudo journalctl -u nginx -f
sudo journalctl -u pm2-root -f
```

## 11. 安全建议

### 11.1 防火墙配置

```bash
# 启用防火墙
sudo ufw enable

# 允许 SSH 连接
sudo ufw allow ssh

# 允许 HTTP 和 HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 查看防火墙状态
sudo ufw status
```

### 11.2 系统安全

```bash
# 定期更新系统
sudo apt update && sudo apt upgrade -y

# 安装安全工具
sudo apt install fail2ban -y

# 配置 fail2ban
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 11.3 应用安全

1. 使用强密码和密钥
2. 定期更新依赖包：`npm audit fix`
3. 启用日志监控
4. 定期备份数据
5. 使用 HTTPS 协议
6. 配置安全头信息

### 11.4 监控告警

```bash
# 安装监控工具
sudo apt install monitoring-plugins -y

# 创建监控脚本
cat > /opt/monitor/health_check.sh << 'EOF'
#!/bin/bash

# 检查应用状态
if ! curl -f http://localhost:3000/health > /dev/null 2>&1; then
    echo "$(date): Application is down!" >> /var/log/health_check.log
    # 重启应用
    pm2 restart mksaas
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "$(date): Disk usage is high: ${DISK_USAGE}%" >> /var/log/health_check.log
fi
EOF

chmod +x /opt/monitor/health_check.sh

# 添加到定时任务（每 5 分钟检查一次）
crontab -e
# 添加：*/5 * * * * /opt/monitor/health_check.sh
```

## 总结

通过以上步骤，您可以将 mksaas-template 项目成功部署到腾讯云服务器中。建议：

1. 在生产环境中使用 Docker 部署以获得更好的隔离性
2. 配置完整的监控和告警系统
3. 定期进行安全更新和备份
4. 根据实际需求调整性能参数
5. 建立完善的运维流程

如有问题，请参考故障排查部分或联系技术支持。 
# 邮箱验证功能修改记录

商家端账号：
merchant@test.com
A123456789


## 修改日期
2025-01-08

## 修改原因
在开发环境中，Better Auth的邮箱验证功能导致注册失败，需要临时禁用以便测试注册和登录流程。

## 修改内容

### 1. 禁用邮箱验证
**文件**: `src/lib/auth.ts`
**修改前**:
```typescript
emailAndPassword: {
  enabled: true,
  // https://www.better-auth.com/docs/concepts/email#2-require-email-verification
  requireEmailVerification: true,
```

**修改后**:
```typescript
emailAndPassword: {
  enabled: true,
  // https://www.better-auth.com/docs/concepts/email#2-require-email-verification
  requireEmailVerification: false,
```

### 2. 修改注册流程
**文件**: `src/components/auth/register-form.tsx`
**修改内容**:
- 使用Better Auth标准注册流程 (`authClient.signUp.email`)
- 注册成功后非阻塞设置用户角色
- 注册成功后自动登录用户
- 移除了自定义注册API

### 3. 新增角色设置API
**文件**: `src/app/api/auth/set-role/route.ts`
**功能**: 在用户注册成功后设置用户角色（user/merchant/admin）
**特点**: 
- 非阻塞调用，不影响注册流程
- 详细的错误处理和日志
- 先检查用户是否存在再更新

### 4. 删除的文件
- `src/app/api/auth/custom-signup/route.ts` - 自定义注册API（已删除）

### 5. 注册流程优化
**关键改进**:
- 将set-role API调用改为非阻塞（使用fetch().then()而不是await）
- 即使角色设置失败也不会阻止注册成功
- 添加了详细的错误日志用于调试

## 恢复邮箱验证功能的步骤

### 1. 重新启用邮箱验证
在 `src/lib/auth.ts` 中将 `requireEmailVerification` 改回 `true`:
```typescript
emailAndPassword: {
  enabled: true,
  requireEmailVerification: true,
```

### 2. 配置邮件服务
确保以下环境变量已正确配置：
- `RESEND_API_KEY` - Resend邮件服务API密钥
- `NEXT_PUBLIC_BASE_URL` - 应用基础URL

### 3. 修改注册流程
在 `src/components/auth/register-form.tsx` 中，将注册成功后的自动登录逻辑改为等待邮箱验证：
```typescript
onSuccess: (ctx) => {
  console.log("register, success:", ctx.data);
  setSuccess(t('checkEmail')); // 提示用户检查邮箱
  
  // 设置用户角色
  if (ctx.data.user?.id) {
    fetch('/api/auth/set-role', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        userId: ctx.data.user.id,
        role: values.accountType,
      }),
    }).catch(console.error);
  }
}
```

### 4. 测试邮件模板
确保以下邮件模板正常工作：
- `src/mail/templates/verify-email.tsx` - 邮箱验证邮件
- `src/mail/templates/forgot-password.tsx` - 密码重置邮件

## 注意事项
1. 在生产环境中，建议启用邮箱验证以确保用户邮箱的有效性
2. 确保邮件服务配置正确，避免注册邮件发送失败
3. 测试邮箱验证链接的有效性和安全性
4. 考虑添加邮箱验证超时处理机制

## 相关文档
- Better Auth邮箱验证文档: https://www.better-auth.com/docs/concepts/email
- 邮件服务配置: https://mksaas.com/docs/email 
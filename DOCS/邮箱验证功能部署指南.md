# 邮箱验证功能部署指南

## 功能概述

MkSaaS 模板已集成完整的邮箱验证功能，包括：

- ✅ 用户注册时自动发送验证邮件
- ✅ 邮箱验证后才能登录系统
- ✅ 验证后自动登录用户
- ✅ 密码重置功能
- ✅ 多语言邮件模板支持
- ✅ 美观的响应式邮件设计

## 环境变量配置

### 必需的环境变量

```bash
# Resend 邮件服务配置
RESEND_API_KEY=your_resend_api_key
RESEND_AUDIENCE_ID=your_resend_audience_id

# 应用基础配置
NEXT_PUBLIC_BASE_URL=https://your-domain.com
```

### 可选的环境变量

```bash
# 数据库配置
DATABASE_URL=your_database_url

# 认证配置
AUTH_SECRET=your_auth_secret

# 社交媒体登录（可选）
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

## Resend 邮件服务配置

### 1. 注册 Resend 账户

1. 访问 [https://resend.com](https://resend.com)
2. 注册账户并验证邮箱
3. 获取 API Key

### 2. 配置发送域名

#### 方法一：使用 Resend 测试域名（开发环境）

```bash
# 在 .env 文件中设置发件人邮箱
RESEND_FROM_EMAIL=onboarding@resend.dev
```

#### 方法二：验证自定义域名（生产环境）

1. 在 Resend 控制台添加您的域名
2. 按照 DNS 配置说明添加记录
3. 等待域名验证完成
4. 设置发件人邮箱为您的域名

```bash
# 在 .env 文件中设置发件人邮箱
RESEND_FROM_EMAIL=noreply@your-domain.com
```

### 3. 配置邮件模板

项目已包含以下邮件模板：

- `verifyEmail` - 邮箱验证邮件
- `forgotPassword` - 密码重置邮件

模板支持中英文双语，自动根据用户语言设置选择。

## 功能测试

### 1. 环境变量检查

```bash
npm run check-env
```

### 2. 邮件发送测试

```bash
# 测试基础邮件发送
npm run test-email-with-env

# 测试完整邮箱验证流程
npm run test-email-verification-flow
```

### 3. 功能验证步骤

1. **注册测试**
   - 访问注册页面
   - 填写邮箱和密码
   - 提交注册表单
   - 检查邮箱是否收到验证邮件

2. **邮箱验证测试**
   - 点击验证邮件中的链接
   - 确认自动登录成功
   - 验证用户状态为已验证

3. **登录测试**
   - 使用未验证的邮箱尝试登录
   - 确认提示需要验证邮箱
   - 使用已验证的邮箱登录
   - 确认登录成功

4. **密码重置测试**
   - 访问忘记密码页面
   - 输入邮箱地址
   - 检查是否收到重置邮件
   - 点击重置链接设置新密码

## 部署到生产环境

### 1. 服务器环境准备

```bash
# 安装 Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 PM2
npm install -g pm2
```

### 2. 项目部署

```bash
# 克隆项目
git clone https://github.com/your-repo/mksaas-template.git
cd mksaas-template

# 安装依赖
npm install

# 构建项目
npm run build

# 使用 PM2 启动
pm2 start npm --name "mksaas" -- start
pm2 save
pm2 startup
```

### 3. 环境变量配置

```bash
# 创建生产环境配置文件
cp .env.example .env

# 编辑环境变量
nano .env
```

确保设置正确的生产环境变量：

```bash
# 生产环境配置
NODE_ENV=production
NEXT_PUBLIC_BASE_URL=https://your-domain.com
RESEND_API_KEY=your_production_resend_api_key
RESEND_FROM_EMAIL=noreply@your-domain.com
DATABASE_URL=your_production_database_url
AUTH_SECRET=your_production_auth_secret
```

### 4. 数据库配置

```bash
# 运行数据库迁移
npm run db:migrate

# 或者推送数据库架构
npm run db:push
```

### 5. 反向代理配置（Nginx）

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 6. SSL 证书配置

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

## 监控和维护

### 1. 日志监控

```bash
# 查看应用日志
pm2 logs mksaas

# 查看错误日志
pm2 logs mksaas --err

# 实时监控
pm2 monit
```

### 2. 邮件发送监控

- 在 Resend 控制台查看邮件发送统计
- 监控邮件发送成功率
- 检查退信和垃圾邮件标记

### 3. 性能监控

```bash
# 查看系统资源使用
htop

# 查看网络连接
netstat -tulpn

# 查看磁盘使用
df -h
```

## 故障排除

### 常见问题

1. **邮件发送失败**
   - 检查 RESEND_API_KEY 是否正确
   - 确认域名是否已验证
   - 检查发件人邮箱格式

2. **邮箱验证链接无效**
   - 检查 NEXT_PUBLIC_BASE_URL 配置
   - 确认域名解析正确
   - 验证 SSL 证书有效

3. **用户无法登录**
   - 检查数据库连接
   - 确认用户邮箱已验证
   - 查看认证日志

4. **邮件模板渲染错误**
   - 检查 React 组件语法
   - 确认模板文件路径正确
   - 验证环境变量配置

### 调试命令

```bash
# 测试邮件发送
npm run test-email-verification-flow

# 检查环境变量
npm run check-env

# 查看应用状态
pm2 status

# 重启应用
pm2 restart mksaas
```

## 安全建议

1. **环境变量安全**
   - 不要在代码中硬编码敏感信息
   - 使用强密码和随机密钥
   - 定期轮换 API 密钥

2. **域名安全**
   - 使用 HTTPS 协议
   - 配置安全头部
   - 启用 CSP 策略

3. **数据库安全**
   - 使用强密码
   - 限制数据库访问权限
   - 定期备份数据

4. **邮件安全**
   - 配置 SPF、DKIM、DMARC 记录
   - 监控邮件发送质量
   - 避免发送垃圾邮件

## 更新和维护

### 1. 代码更新

```bash
# 拉取最新代码
git pull origin main

# 安装依赖
npm install

# 构建项目
npm run build

# 重启应用
pm2 restart mksaas
```

### 2. 数据库迁移

```bash
# 运行数据库迁移
npm run db:migrate
```

### 3. 备份策略

```bash
# 数据库备份
pg_dump your_database > backup_$(date +%Y%m%d_%H%M%S).sql

# 文件备份
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz /path/to/app
```

## 联系支持

如果在部署过程中遇到问题，请：

1. 检查本文档的故障排除部分
2. 查看应用日志和错误信息
3. 确认环境变量配置正确
4. 联系技术支持团队

---

**最后更新**: 2024年12月
**版本**: 1.0.0 
# 未验证账户重新注册功能说明

## 功能概述

本功能允许用户在首次注册但未验证邮箱的情况下，使用相同邮箱重新注册。系统会自动处理未验证账户的清理和重新注册流程。

## 功能特性

### ✅ 核心功能
- 允许未验证邮箱的用户重新注册
- 自动删除旧的未验证账户
- 创建新的注册请求和验证邮件
- 防止已验证账户被覆盖
- 提供清晰的用户反馈

### 🔒 安全机制
- 只有未验证的账户可以重新注册
- 已验证的账户不能重新注册
- 重新注册会删除旧的未验证账户
- 每次重新注册都会发送新的验证邮件

## 技术实现

### API 端点
```
POST /api/auth/register-with-verification
```

### 请求参数
```json
{
  "email": "user@example.com",
  "password": "securepassword",
  "name": "用户名",
  "accountType": "user",
  "callbackURL": "https://example.com/callback"
}
```

### 响应状态
- `200`: 注册成功
- `400`: 缺少必需字段
- `409`: 邮箱已验证
- `500`: 服务器错误

## 处理流程

### 1. 邮箱检查
```typescript
// 检查邮箱是否已存在
const existingUser = await db.query.users.findFirst({
  where: eq(users.email, email),
});
```

### 2. 状态判断
```typescript
if (existingUser) {
  if (!existingUser.emailVerified) {
    // 未验证账户，允许重新注册
    shouldDeleteExisting = true;
  } else {
    // 已验证账户，拒绝注册
    return NextResponse.json(
      { error: 'Email already registered and verified' },
      { status: 409 }
    );
  }
}
```

### 3. 账户清理
```typescript
// 删除未验证的旧账户
if (shouldDeleteExisting && existingUser) {
  await db.delete(users).where(eq(users.id, existingUser.id));
}
```

### 4. 新账户创建
```typescript
// 使用 Better Auth 创建新用户
const result = await auth.signUp.email({
  email,
  password,
  name,
  callbackURL,
});
```

## 用户场景

### 场景1: 首次注册
1. 用户填写注册表单
2. 系统创建账户并发送验证邮件
3. 用户未验证邮箱

### 场景2: 重新注册（未验证）
1. 用户使用相同邮箱重新注册
2. 系统检测到未验证的旧账户
3. 删除旧账户并创建新账户
4. 发送新的验证邮件

### 场景3: 重新注册（已验证）
1. 用户使用已验证的邮箱重新注册
2. 系统拒绝注册并提示直接登录

## 邮件流程

### 首次注册
```
用户注册 → 发送验证邮件 → 用户未验证
```

### 重新注册
```
用户重新注册 → 删除旧账户 → 发送新验证邮件 → 用户验证
```

### 验证成功
```
用户点击验证链接 → 验证成功 → 自动登录
```

## 错误处理

### 已验证邮箱错误
```typescript
if (response.status === 409) {
  setError(t('emailAlreadyVerified') || 'Email already registered and verified');
}
```

### 翻译键
```json
{
  "emailAlreadyVerified": "该邮箱已注册并验证，请直接登录"
}
```

## 测试脚本

### 运行测试
```bash
npm run test-re-registration
```

### 测试内容
- 环境变量检查
- 功能说明验证
- 技术实现确认
- 安全机制检查

## 配置要求

### 环境变量
```bash
RESEND_API_KEY=your_resend_api_key
NEXT_PUBLIC_BASE_URL=https://your-domain.com
```

### 数据库要求
- 用户表需要 `emailVerified` 字段
- 支持用户删除操作
- 支持事务处理

## 安全考虑

### 1. 防止账户覆盖
- 已验证的账户不能被重新注册
- 提供明确的错误提示

### 2. 数据清理
- 删除旧的未验证账户
- 避免数据库中的垃圾数据

### 3. 邮件安全
- 每次重新注册发送新的验证邮件
- 使用安全的验证令牌

### 4. 操作日志
- 记录重新注册操作
- 便于审计和调试

## 用户体验

### 1. 清晰的反馈
- 成功注册：显示"请检查您的邮箱"
- 已验证邮箱：提示直接登录
- 其他错误：显示具体错误信息

### 2. 简化的流程
- 用户无需手动删除旧账户
- 系统自动处理所有清理工作
- 提供一致的注册体验

### 3. 多语言支持
- 支持中英文错误提示
- 邮件模板多语言支持

## 监控和维护

### 1. 日志监控
```typescript
console.log(`User ${email} exists but not verified, allowing re-registration`);
console.log(`Deleted unverified user ${email} for re-registration`);
```

### 2. 错误处理
```typescript
try {
  // 注册逻辑
} catch (error) {
  console.error('Registration error:', error);
  return NextResponse.json(
    { error: 'Internal server error' },
    { status: 500 }
  );
}
```

### 3. 性能考虑
- 数据库查询优化
- 邮件发送异步处理
- 错误响应快速返回

## 部署注意事项

### 1. 数据库迁移
确保用户表包含必要的字段：
- `emailVerified`: 邮箱验证状态
- `id`: 用户唯一标识
- `email`: 邮箱地址

### 2. 环境配置
- 设置正确的 Resend API 密钥
- 配置应用基础 URL
- 确保邮件服务正常工作

### 3. 测试验证
- 测试首次注册流程
- 测试重新注册流程
- 测试已验证邮箱的处理
- 验证邮件发送功能

## 故障排除

### 常见问题

1. **重新注册失败**
   - 检查数据库连接
   - 验证用户表结构
   - 确认 API 路由配置

2. **邮件发送失败**
   - 检查 Resend API 密钥
   - 验证邮件模板配置
   - 确认域名设置

3. **验证状态错误**
   - 检查 `emailVerified` 字段
   - 验证数据库查询逻辑
   - 确认用户状态更新

### 调试命令
```bash
# 测试重新注册功能
npm run test-re-registration

# 检查环境变量
npm run check-env

# 测试邮件发送
npm run test-email-with-env
```

---

**最后更新**: 2024年12月
**版本**: 1.0.0 